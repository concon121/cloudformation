Parameters:
  ProjectName:
    Description: The name of of the project
    Type: String
    Default: common

Resources:

<%= partial('iam/service-role.yaml.erb',
            id: 'LambdaServiceRole',
            name: 'cloudfrontoriginaccessidentity',
            services: ['lambda'],
            policies: ['iam/policies/actions/cloudfront-create-origin-access-identity.yaml.erb',
                       'iam/policies/actions/s3.yaml.erb',
                       'iam/policies/actions/logs.yaml.erb'],
            s3s: {
              'names' => [@lambda_bucket]
              },
            serviceName: "create-origin-access-identity") %>

<%= partial('lambda/lambda.yaml.erb',
            id: 'CloudFrontOriginAccessIdentityLambda',
            name: 'create-origin-access-identity',
            description: 'Creates an origin access identity in CloudFront',
            handler: 'lambda_function.lambda_handler',
            role: '!GetAtt [LambdaServiceRole, Arn]',
            runtime: 'python2.7',
            bucket: @lambda_bucket,
            key: 'origin-access-identity.zip') %>

Outputs:
  CloudFrontOriginAccessIdentityLambda:
    Description: The resource name of the lambda which creates origin access identities in CloudFront
    Value:
      Ref: CloudFrontOriginAccessIdentityLambda
  CloudFrontOriginAccessIdentityLambdaArn:
    Description: The ARN of the lambda which creates origin access identities in CloudFront
    Value: !GetAtt [CloudFrontOriginAccessIdentityLambda, Arn]
