---
AWSTemplateFormatVersion: 2010-09-09

Parameters:
  ProjectName:
    Description: The name of the project
    Type: String
  IndexDocument:
    Description: The index document for static S3 websites
    Type: String
    Default: index.html
  WebsiteRootDirectory:
    Description: The directory in code commit containing the index file
    Type: String
    Default: '.'
  CommonRepo:
    Description: The name of the gir repository containing the common code
    Type: String

Mappings:
<%= partial('mappings/region-map.yaml.erb', {}, indent: 2) %>


Resources:

  # ---------------------------------------------------------------------------
  # IAM Security Role for the pipeline to assume
  # ---------------------------------------------------------------------------

  <%
    appBucketId = 'AppBucket'
    appBucketName = "!Sub 'pr52-s3-${ProjectName}-hosting-${AWS::AccountId}-dev'"
    stagingBucket =  "!Sub 'pr52-s3-${ProjectName}-pipelinestaging-${AWS::AccountId}-dev'"
    codebuildsArry = [
      "ApplicationUploadBuild"
    ]
    s3Arry = {
      'arns' => ['AppBucket', 'DevelopmentPipelineStagingBucket']
    }
    codecommits = ["ProjectName", "CommonRepo"]
    pipelineRoleId = 'PipelineRole'
    pipelineId = 'DevelopmentPipeline'
    buildId = 'ApplicationUploadBuild'
    stagingBucketId = pipelineId + 'StagingBucket'
  %>

<%= partial('iam/pipeline-assumed-role.yaml.erb',
            id: pipelineRoleId,
            codebuilds: codebuildsArry,
            s3s: s3Arry,
            codecommits: codecommits) %>

  # --------------------------------------------------------------------------
  # CodeCommit Repository
  # --------------------------------------------------------------------------

<%= partial('codecommit/repository.yaml.erb',
            id: 'DevelopmentRepo',
            name: '!Ref ProjectName',
            description: "!Join [' ' , ['Git repository for:', !Ref ProjectName]]") %>

  # ---------------------------------------------------------------------------
  # S3 Static Website Bucket
  # ---------------------------------------------------------------------------

<%= partial('s3/www-bucket.yaml.erb',
            id: appBucketId,
            bucketName: appBucketName,
            role: pipelineRoleId,
            s3IpWhiteList: @ip_white_list) %>

  # ---------------------------------------------------------------------------
  # CodeBuild configuration
  # ---------------------------------------------------------------------------

<%= partial('codebuild/s3-upload.yaml.erb',
            id: buildId,
            buildSpec: 'codebuild/buildspecs/static-website.yaml.erb',
            environmentVars: 'codebuild/environmentVars/static-website.yaml.erb',
            appBucket: appBucketId,
            stagingBucket: stagingBucketId,
            role: pipelineRoleId,
            cloudfront: false,
            commonRepo: true) %>

  # ---------------------------------------------------------------------------
  # Pipeline definition
  # ---------------------------------------------------------------------------

<%= partial('s3/versioned-bucket.yaml.erb',
            id: stagingBucketId,
            name: stagingBucket) %>

<%= partial('codepipeline/s3-static-website-pipeline.yaml.erb',
            id: pipelineId,
            role: pipelineRoleId,
            buildName: buildId,
            testing: false,
            branch: 'develop',
            repo: '!Ref ProjectName',
            commonRepo: '!Ref CommonRepo',
            autotrigger: true,
            stagingBucket: stagingBucketId) %>

  # ---------------------------------------------------------------------------
  # Additional Access Policies
  # ---------------------------------------------------------------------------

<%= partial('iam/policies/codecommit.yaml.erb',
            id: 'CodeCommitAccessPolicy',
            codecommits: codecommits) %>

<%= partial('iam/policies/codebuild.yaml.erb',
            id: 'CodeBuildAccessPolicy',
            codebuilds: codebuildsArry) %>

<%= partial('iam/policies/codepipeline.yaml.erb',
            id: 'CodePipelineAccessPolicy',
            pipelines: [pipelineId]) %>

  # --------------------------------------------------------------------------
  # Outputs
  # --------------------------------------------------------------------------

Outputs:
  WebsiteUrl:
    Description: The URL to connect to the website
    Value: !GetAtt [AppBucket, WebsiteURL]
