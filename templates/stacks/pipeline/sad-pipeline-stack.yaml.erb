---
AWSTemplateFormatVersion: 2010-09-09

Parameters:
  ProjectName:
    Description: The name of the project
    Type: String
  CodeCommitProject:
    Description: The name of the AWS Code Commit project to build
    Type: String
  StagingBucketName:
    Description: The name of the staging s3 bucket for development
    Type: String
  RootDomainZoneID:
    Description: The zone ID of the root domain
    Type: String
    Default: ''
  RootDomain:
    Description: The root domain
    Type: String
  IndexDocument:
    Description: The index document for static S3 websites
    Type: String
    Default: index.html
  WebsiteRootDirectory:
    Description: The directory in code commit containing the index file
    Type: String
    Default: '.'
  IPWhiteList:
    Description: IP addresses allowed to access the static website, in CIDR notation.
    Type: String
  AutoTrigger:
    Description: Should the pipeline poll for changes and automatically trigger?
    Type: String
    Default: 'false'
  WorkingBranch:
    Description: The code branch to checkout and deploy
    Type: String
<% if @pipeline['testing'] %>
  ProdStagingBucketName:
    Description: The staging bucket which production deployments will pull from
    Type: String
<% end %>
<% if @pipeline['codecommitPolicy'] %>
  UserRole:
    Description: The role that resource access policies will be applied to.
    Type: String
<% end %>

Mappings:
<%= partial('mappings/region-map.yaml.erb', {}, indent: 2) %>

Conditions:
<%= partial('conditions/s3-static-website-conditions.yaml.erb', {}) %>

Resources:
# =============================================================================
# Environment: <%= @environment %>
# =============================================================================
  # ---------------------------------------------------------------------------
  # IAM Security Role for the <%= @environment %> pipeline
  # ---------------------------------------------------------------------------
<% if @pipeline['testing'] %>
  <% codebuildsArry = ["!Join [\'-\', [!Ref \'ProjectName\', \'Deploy\', \'#{@environment}\']]",
                       "!Join [\'-\', [!Ref \'ProjectName\', \'Stage\', \'prod\']]"] %>
  <% s3Arry = {
      'names' => ['!Ref \'StagingBucketName\'', '!Ref \'ProdStagingBucket\''],
      'arns' => ['AppBucket']
  } %>
<% else %>
  <% codebuildsArry = ["!Join [\'-\', [!Ref \'ProjectName\', \'Deploy\', \'#{@environment}\']]"] %>
  <% s3Arry = {
      'names' => ['!Ref \'StagingBucketName\''],
      'arns' => ['AppBucket']
    } %>
<% end %>

<% if @pipeline['enabled'] %>
  <% codecommits = ["!Ref \'CodeCommitProject\'"] %>
<% end %>

<%= partial('iam/pipeline-assumed-role.yaml.erb',
            tag: @environment,
            pipelineId: 'S3StaticWebsitePipeline',
            codebuilds: codebuildsArry,
            s3s: s3Arry,
            codecommits: codecommits,
            roleId: 'PipelineRole') %>
  # ---------------------------------------------------------------------------
  # CodeBuild configuration for the <%= @environment %> pipeline
  # ---------------------------------------------------------------------------
<%= partial('s3/www-bucket.yaml.erb', tag: @tag) %>
<%= partial('codebuild/s3-upload.yaml.erb',
            tag: @environment,
            action: 'Deploy',
            buildSpec: 'codebuild/buildspecs/static-website.yaml.erb',
            environmentVars: 'codebuild/environmentVars/static-website.yaml.erb',
            logicalId: 'ApplicationUploadBuild') %>
<% if @pipeline['testing'] %>
<%= partial('s3/versioned-bucket.yaml.erb',
            id: 'ProdStagingBucket',
            name: '!Ref \'ProdStagingBucketName\'') %>
<%= partial('codebuild/s3-upload.yaml.erb',
            tag: 'prod',
            action: 'Stage',
            buildSpec: 'codebuild/buildspecs/zip-and-upload-to-s3.yaml.erb',
            environmentVars: 'codebuild/environmentVars/zip-and-upload-to-s3.yaml.erb',
            s3Bucket: '!Ref \'ProdStagingBucketName\'',
            logicalId: 'ProdStagingUploadBuild') %>
<% end %>
  # ---------------------------------------------------------------------------
  # Pipeline definition: <%= @environment %>
  # ---------------------------------------------------------------------------
<% if @pipeline['enabled'] %>
<%= partial('codepipeline/s3-static-website-pipeline.yaml.erb',
            tag: @environment,
            buildName: "!Join ['-', [!Ref 'ProjectName', 'Build', #{@environment}]]",
            testing: @pipeline['testing']) %>
<% end %>

  # ---------------------------------------------------------------------------
  # Access Policies
  # ---------------------------------------------------------------------------
<%= partial('iam/policies/codecommit.yaml.erb',
            id: 'CodeCommitAccessPolicy',
            name: "!Join [\'-\', [!Ref ProjectName, 'access', 'policy']]",
            codecommits: ['!Ref ProjectName']) %>
