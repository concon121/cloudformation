---
AWSTemplateFormatVersion: 2010-09-09

Parameters:
  ProjectName:
    Description: The name of the project
    Type: String
  CodeCommitProject:
    Description: The name of the AWS Code Commit project to build
    Type: String
  StagingBucketName:
    Description: The name of the staging s3 bucket for development
    Type: String
  RootDomainZoneID:
    Description: The zone ID of the root domain
    Type: String
    Default: ''
  RootDomain:
    Description: The root domain
    Type: String
  IndexDocument:
    Description: The index document for static S3 websites
    Type: String
    Default: index.html
  WebsiteRootDirectory:
    Description: The directory in code commit containing the index file
    Type: String
    Default: '.'
  AllowedIPRange:
    Description: IP addresses allowed to access the static website, in CIDR notation.
    Type: String
  AutoTrigger:
    Description: Should the pipeline poll for changes and automatically trigger?
    Type: String
    Default: 'false'
  WorkingBranch:
    Description: The code branch to checkout and deploy
    Type: String
<% if @pipeline['testing'] %>
  ProdStagingBucketName:
    Description: The staging bucket which production deployments will pull from
    Type: String
<% end %>
Mappings:
<%= partial('mappings/region-map.yaml.erb', {}, indent: 2) %>

Conditions:
<%= partial('conditions/s3-static-website-conditions.yaml.erb', {}) %>

Resources:
# =============================================================================
# Environment: <%= @environment %>
# =============================================================================
  # ---------------------------------------------------------------------------
  # IAM Security Role for the <%= @environment %> pipeline
  # ---------------------------------------------------------------------------
<%= partial('iam/pipeline-iam.yaml.erb', tag: @environment, pipelineId: 'S3StaticWebsitePipeline', codebuilds: ["!Join ['-', [!Ref 'ProjectName', 'Build', '<%= @environment %>']]", "!Join ['-', [!Ref 'ProjectName', 'Build', 'prod']]"], codebuildId: 'ApplicationUploadBuild') %>
  # ---------------------------------------------------------------------------
  # CodeBuild configuration for the <%= @environment %> pipeline
  # ---------------------------------------------------------------------------
<%= partial('s3/www-bucket.yaml.erb', tag: @tag) %>
<%= partial('codebuild/s3-upload.yaml.erb', tag: @environment, buildSpec: 'codebuild/buildspecs/static-website.yaml.erb', environmentVars: 'codebuild/environmentVars/static-website.yaml.erb', logicalId: 'ApplicationUploadBuild') %>
<% if @pipeline['testing'] %>
<%= partial('s3/versioned-bucket.yaml.erb', id: 'ProdStagingBucket', name: '!Ref \'ProdStagingBucketName\'') %>
<%= partial('codebuild/s3-upload.yaml.erb', tag: 'prod', buildSpec: 'codebuild/buildspecs/zip-and-upload-to-s3.yaml.erb', environmentVars: 'codebuild/environmentVars/zip-and-upload-to-s3.yaml.erb', s3Bucket: '!Ref \'ProdStagingBucketName\'', logicalId: 'ProdStagingUploadBuild') %>
<% end %>
  # ---------------------------------------------------------------------------
  # Pipeline definition: <%= @environment %>
  # ---------------------------------------------------------------------------
<%= partial('codepipeline/s3-static-website-pipeline.yaml.erb', tag: @environment, buildName: "!Join ['-', [!Ref 'ProjectName', 'Build', #{@environment}]]", testing: @pipeline['testing']) %>
