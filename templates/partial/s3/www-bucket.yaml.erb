  <%= @id %>:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: PublicReadWrite
      BucketName: <%= @bucketName %>
      VersioningConfiguration:
        Status: 'Enabled'
      WebsiteConfiguration:
        IndexDocument: !Ref 'IndexDocument'

  <%= @id %>Policy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: <%= @id %>
      PolicyDocument:
        Statement:
          - Sid: 'AllowUsers'
            <% if @s3IpWhiteList && !@s3IpWhiteList.nil? %>
            Effect: 'Deny'
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Join ['', ['arn:aws:s3:::', <%= @bucketName %>, '/*']]
            Condition:
              NotIpAddress:
                aws:SourceIp: <% @s3IpWhiteList.each do |ip| %>
                  - <%= ip['value'] %> <% end %>
            <% else %>
            Effect: Allow
            Principal: '*'
            Action: s3:GetObject
            Resource: !Join ['', ['arn:aws:s3:::', <%= @bucketName %>, '/*']]
            <% end %>
