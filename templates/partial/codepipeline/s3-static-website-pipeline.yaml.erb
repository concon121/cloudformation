<%= partial('s3/default-bucket.yaml.erb',
            id: 'PipelineStagingBucket',
            name: @stagingBucket) %>

<% appOutput = 'app-source' %>
<% commonOutput = 'common-source' %>

  S3StaticWebsitePipeline:
    Type: "AWS::CodePipeline::Pipeline"
    DependsOn:
      - PipelineRole
    Properties:
      Name: !Join ['-', [!Ref 'ProjectName', 'Pipeline', '<%= @tag %>']]
      RoleArn: !GetAtt
        - PipelineRole
        - Arn
      ArtifactStore:
        Location:
          Ref: 'PipelineStagingBucket'
        Type: "S3"
      Stages:
        - Name: "Source"
          Actions:
<%= partial('codepipeline/stages/codecommit.yaml.erb',
            name: 'ApplicationSource',
            repo: @repo,
            branch: @branch,
            autotrigger: @autotrigger,
            output: appOutput) %>
<% if @commonRepo && !@commonRepo.nil? %>
<%= partial('codepipeline/stages/codecommit.yaml.erb',
            name: 'CommonSource',
            repo: @commonRepo,
            branch: @branch,
            autotrigger: @autotrigger,
            output: commonOutput) %>
<% end %>
        - Name: 'Deployment'
          Actions:
<%= partial('codepipeline/stages/s3-upload-codebuild.yaml.erb',
            name: 'DeployApp',
            buildName: "ApplicationUploadBuild",
            input: appOutput) %>
<% if @commonRepo && !@commonRepo.nil? %>
<%= partial('codepipeline/stages/s3-upload-codebuild.yaml.erb',
            name: 'DeployCommon',
            buildName: "ApplicationUploadBuild",
            input: commonOutput,
            runOrder: 2) %>
<% end %>
