<% appOutput = 'app-source' %>
<% buildOrder = 1 %>
  <%= @id %>:
    Type: "AWS::CodePipeline::Pipeline"
    DependsOn:
      - PipelineRole
    Properties:
      Name: !Sub '${ProjectName}-pipeline-<%= @tag %>'
      RoleArn: !GetAtt [<%= @role %>, Arn]
      RestartExecutionOnUpdate: false
      ArtifactStore:
        Location:
          Ref: <%= @stagingBucket %>
        Type: "S3"
      Stages:
        - Name: "Source"
          Actions:<% @projects.each do |project| %>
<%= partial('codepipeline/stages/codecommit.yaml.erb',
            name: project['id'] + 'Source',
            repo: project['name'],
            output: project['id'] + 'Output') %><% end %>
        - Name: 'Deployment'
          Actions:<% @projects.each do |project| %>
<%= partial('codepipeline/stages/s3-upload-codebuild.yaml.erb',
            name: 'Deploy' + project['id'],
            input: project['id'] + 'Output',
            runOrder: buildOrder) %>
<% buildOrder += 1 %>
<% end %>
