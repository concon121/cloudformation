# This file was generated with lono. Do not edit directly, the changes will be lost.
# More info: https://github.com/tongueroo/lono
---
AWSTemplateFormatVersion: 2010-09-09
Parameters:
  PipelinePolicyName:
    Description: Name of the security policy
    Type: String
  DevBucketName:
    Description: S3 bucket for dev app
    Type: String
  ProdBucketName:
    Description: S3 bucket for prod app
    Type: String
  PipelineRoleName:
    Description: Name of the security Role
    Type: String
  PipelineName:
    Description: Name of the pipeline
    Type: String
  BuildProjectName:
    Description: Name of the build project
    Type: String
  CodeCommitProject:
    Description: The name of the AWS Code Commit project to build
    Type: String
  S3Bucket:
    Description: The URI for the S3 bucket containing the templates
    Type: String
  StagingBucketName:
    Description: The name of the staging s3 bucket for development
    Type: String
  RootDomainZoneID:
    Description: The zone ID of the root domain
    Type: String
Resources:
# =============================================================================
# S3 Buckets
# =============================================================================
  DevAppBucket:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 's3', 'www-bucket.template']]
      TimeoutInMinutes: "60"
      Parameters:
        NewSubDomain: !Ref 'DevBucketName'
        RootDomainZoneID: !Ref 'RootDomainZoneID'
  ProdAppBucket:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 's3', 'www-bucket.template']]
      TimeoutInMinutes: "60"
      Parameters:
        NewSubDomain: !Ref 'ProdBucketName'
        RootDomainZoneID: !Ref 'RootDomainZoneID'
  StagingBucket:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 's3', 'default-bucket.template']]
      TimeoutInMinutes: "60"
      Parameters:
        Name: !Ref 'StagingBucketName'
# =============================================================================
# Environment: dev
# =============================================================================
  # ---------------------------------------------------------------------------
  # IAM Security Role for the dev pipeline
  # ---------------------------------------------------------------------------
  DevSecurityRole:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 'iam', 'pipeline-iam.template']]
      TimeoutInMinutes: "60"
      Parameters:
        RoleName: !Join ['-', [!Ref 'PipelineRoleName', 'dev']]
        PolicyName: !Join ['-', [!Ref 'PipelinePolicyName', 'dev']]
        BuildProjectName: !Join ['-', [!Ref 'BuildProjectName', 'dev']]
        CodeCommitProject: !Ref 'CodeCommitProject'
        PipelineName: !Join ['-', [!Ref 'PipelineName', 'dev']]
        S3AppBucket: !Ref 'DevBucketName'
        S3StagingBucket: !Ref 'StagingBucketName'
  # ---------------------------------------------------------------------------
  # CodeBuild configuration for the dev pipeline
  # ---------------------------------------------------------------------------
  DevBuild:
    Type: "AWS::CloudFormation::Stack"
    DependsOn:
      - 'DevSecurityRole'
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 'codebuild', 's3-upload.template']]
      TimeoutInMinutes: "60"
      Parameters:
        Name: !Ref 'BuildProjectName'
        Environment: 'dev'
        S3Bucket: !Ref 'DevBucketName'
        RoleName: !Join ['-', [!Ref 'PipelineRoleName', 'dev']]
  # ---------------------------------------------------------------------------
  # Pipeline definition: dev
  # ---------------------------------------------------------------------------
  DevelopmentPipeline:
    Type: "AWS::CodePipeline::Pipeline"
    DependsOn:
      - 'DevSecurityRole'
      - 'DevBuild'
      - 'DevAppBucket'
      - 'StagingBucket'
    Properties:
      Name: !Join ['-', [!Ref 'PipelineName', 'dev']]
      RoleArn: !Join ['/', ['arn:aws:iam::977855701381:role', !Join ['-', [!Ref 'PipelineRoleName', 'dev']]]]
      ArtifactStore:
        Location: !Ref 'StagingBucketName'
        Type: "S3"
      Stages:
        - Name: "Source"
          Actions:
            - Name: "ApplicationSource"
              ActionTypeId:
                Category: "Source"
                Owner: "AWS"
                Provider: "CodeCommit"
                Version: "1"
              RunOrder: 1
              Configuration:
                BranchName: "develop"
                RepositoryName: !Ref 'CodeCommitProject'
              OutputArtifacts:
                - Name: "app-source"
        - Name: "Build"
          Actions:
            - Name: "Deployment"
              ActionTypeId:
                Category: "Build"
                Owner: "AWS"
                Provider: "CodeBuild"
                Version: "1"
              RunOrder: 1
              Configuration:
                ProjectName: !Join ['-', [!Ref 'BuildProjectName', 'dev']]
              InputArtifacts:
                - Name: "app-source"
# =============================================================================
# Environment: prod
# =============================================================================
  # ---------------------------------------------------------------------------
  # IAM Security Role for the prod pipeline
  # ---------------------------------------------------------------------------
  ProdSecurityRole:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 'iam', 'pipeline-iam.template']]
      TimeoutInMinutes: "60"
      Parameters:
        RoleName: !Join ['-', [!Ref 'PipelineRoleName', 'prod']]
        PolicyName: !Join ['-', [!Ref 'PipelinePolicyName', 'prod']]
        BuildProjectName: !Join ['-', [!Ref 'BuildProjectName', 'prod']]
        CodeCommitProject: !Ref 'CodeCommitProject'
        PipelineName: !Join ['-', [!Ref 'PipelineName', 'prod']]
        S3AppBucket: !Ref 'ProdBucketName'
        S3StagingBucket: !Ref 'StagingBucketName'
  # ---------------------------------------------------------------------------
  # CodeBuild configuration for the prod pipeline
  # ---------------------------------------------------------------------------
  ProdBuild:
    Type: "AWS::CloudFormation::Stack"
    DependsOn:
      - 'ProdSecurityRole'
    Properties:
      TemplateURL: !Join ['/', [!Ref 'S3Bucket', 'templates', 'codebuild', 's3-upload.template']]
      TimeoutInMinutes: "60"
      Parameters:
        Name: !Ref 'BuildProjectName'
        Environment: 'prod'
        S3Bucket: !Ref 'ProdBucketName'
        RoleName: !Join ['-', [!Ref 'PipelineRoleName', 'prod']]
  # ---------------------------------------------------------------------------
  # Pipeline definition: prod
  # ---------------------------------------------------------------------------
  ProductionPipeline:
    Type: "AWS::CodePipeline::Pipeline"
    DependsOn:
      - 'ProdSecurityRole'
      - 'ProdBuild'
      - 'ProdAppBucket'
      - 'StagingBucket'
    Properties:
      Name: !Join ['-', [!Ref 'PipelineName', 'prod']]
      RoleArn: !Join ['/', ['arn:aws:iam::977855701381:role', !Join ['-', [!Ref 'PipelineRoleName', 'prod']]]]
      ArtifactStore:
        Location: !Ref 'StagingBucketName'
        Type: "S3"
      Stages:
        - Name: "Source"
          Actions:
            - Name: "ApplicationSource"
              ActionTypeId:
                Category: "Source"
                Owner: "AWS"
                Provider: "CodeCommit"
                Version: "1"
              RunOrder: 1
              Configuration:
                BranchName: "master"
                RepositoryName: !Ref 'CodeCommitProject'
                PollForSourceChanges: 'false'
              OutputArtifacts:
                - Name: "app-source"
        - Name: "Build"
          Actions:
            - Name: "Deployment"
              ActionTypeId:
                Category: "Build"
                Owner: "AWS"
                Provider: "CodeBuild"
                Version: "1"
              RunOrder: 1
              Configuration:
                ProjectName: !Join ['-', [!Ref 'BuildProjectName', 'prod']]
              InputArtifacts:
                - Name: "app-source"
